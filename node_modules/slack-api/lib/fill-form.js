var _ = require('lodash');
var cheerio = require('cheerio');
var errorFactory = require('error-factory');
var request = require('superagent');
var url = require('url');

module.exports = function fillForm (formQuery, data, done) {
    return function fillFormResponder (err, res) {
        if (err) {
            done(err, res);
        }

        var $ = cheerio.load(res.text);
        var form = $(formQuery).eq(0);
        var inputs = form.serializeArray();
        var submitUrl = form.attr('action');

        var formData = {};

        _.each(inputs, function (input) {
            formData[input.name] = input.value;
        });

        _.extend(formData, data);

        request
            .post(url.resolve(res.request.url, submitUrl))
            .type('form')
            .send(formData)
            .end(done)
        ;
    };
};
